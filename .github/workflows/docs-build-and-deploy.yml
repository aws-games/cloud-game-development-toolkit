name: Build and Deploy Documentation (Reusable)

on:
  workflow_call:
    inputs:
      mode:
        description: "Deployment mode: 'preview', 'latest', or 'version'"
        required: true
        type: string
      version:
        description: "Version string for 'version' mode (e.g., v1.0.0)"
        required: false
        type: string
      alias:
        description: "Alias for 'version' mode (e.g., stable)"
        required: false
        type: string
      destination_dir:
        description: "Destination directory for 'preview' mode (e.g., preview/pr-123)"
        required: false
        type: string
      git_ref:
        description: "Git ref to checkout (branch, tag, or commit)"
        required: false
        type: string
        default: ""

permissions:
  contents: write
  pages: write

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          ref: ${{ inputs.git_ref || github.ref }}

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: "docs/requirements.txt"

      - name: Configure git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'

      - name: Install dependencies
        run: pip install -r docs/requirements.txt

      - name: Deploy preview
        if: inputs.mode == 'preview'
        run: |
          # Extract PR number from destination_dir (preview/pr-123 -> 123)
          PR_NUM=$(echo "${{ inputs.destination_dir }}" | grep -oP 'pr-\K\d+')
          # Deploy as a preview "version" with mike (builds from current branch, pushes to gh-pages)
          mike deploy --push "preview-pr-${PR_NUM}"

      - name: Deploy to latest
        if: inputs.mode == 'latest'
        run: |
          mike deploy --push --update-aliases latest
          mike set-default --push latest

      - name: Deploy versioned docs
        if: inputs.mode == 'version'
        run: |
          mike deploy --push --update-aliases ${{ inputs.version }} ${{ inputs.alias }}
