name: Validate Documentation

on:
  pull_request:
    branches: [main]
    paths:
      - "**/*.md"
      - "docs/**"
      - ".config/.markdownlint-cli2.jsonc"
      - ".config/lychee.toml"
  push:
    branches: [main]
    # No path filter - run on every push to catch all issues
  workflow_dispatch:
  workflow_call:
    inputs:
      scope:
        description: "Validation scope: 'changed' for only changed files, 'all' for entire project"
        required: false
        type: string
        default: "changed"
      create_issue:
        description: "Whether to create a GitHub issue on validation failure"
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  check-links:
    name: Check Links
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Determine scope
        id: scope
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "scope=changed" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "workflow_call" ]; then
            echo "scope=${{ inputs.scope || 'all' }}" >> $GITHUB_OUTPUT
          else
            echo "scope=all" >> $GITHUB_OUTPUT
          fi

      - name: Get changed markdown/html files
        if: steps.scope.outputs.scope == 'changed'
        id: changed-files
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47.0.0
        with:
          files: |
            **/*.md
            **/*.html

      - name: Check links in changed files
        if: steps.scope.outputs.scope == 'changed' && steps.changed-files.outputs.any_changed == 'true'
        id: lychee-changed
        uses: lycheeverse/lychee-action@a8c4c7cb88f0c7386610c35eb25108e448569cb0 # v2.7.0
        with:
          args: --config .config/lychee.toml --no-progress ${{ steps.changed-files.outputs.all_changed_files }}
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check all links
        if: steps.scope.outputs.scope == 'all'
        id: lychee-all
        uses: lycheeverse/lychee-action@a8c4c7cb88f0c7386610c35eb25108e448569cb0 # v2.7.0
        with:
          args: --config .config/lychee.toml --no-progress '**/*.md' '**/*.html'
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  lint-markdown:
    name: Lint Markdown
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Determine scope
        id: scope
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "scope=changed" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "workflow_call" ]; then
            echo "scope=${{ inputs.scope || 'all' }}" >> $GITHUB_OUTPUT
          else
            echo "scope=all" >> $GITHUB_OUTPUT
          fi

      - name: Get changed markdown files
        if: steps.scope.outputs.scope == 'changed'
        id: changed-files
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47.0.0
        with:
          files: "**/*.md"
          separator: " "

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: "20"

      - name: Install GitHub Actions formatter
        run: npm install markdownlint-cli2-formatter-template

      - name: Lint markdown files
        id: lint
        run: |
          if [ "${{ steps.scope.outputs.scope }}" == "changed" ]; then
            if [ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]; then
              npx markdownlint-cli2 \
                --config .config/ci.markdownlint-cli2.jsonc \
                ${{ steps.changed-files.outputs.all_changed_files }}
            fi
          else
            npx markdownlint-cli2 \
              --config .config/ci.markdownlint-cli2.jsonc \
              '**/*.md'
          fi

  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: "docs/requirements.txt"

      - name: Build documentation
        id: build
        run: |
          pip install -r docs/requirements.txt
          mkdocs build --strict

  report-status:
    name: Report Documentation Status
    needs: [check-links, lint-markdown, build-docs]
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    if: always()

    steps:
      # PR Comments: Delete comments for checks that are now passing
      - name: Delete PR comment - Link Check Success
        if: github.event_name == 'pull_request' && needs.check-links.result == 'success'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: doc-link-check
          delete: true

      - name: Delete PR comment - Lint Success
        if: github.event_name == 'pull_request' && needs.lint-markdown.result == 'success'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: doc-lint-failure
          delete: true

      - name: Delete PR comment - Build Success
        if: github.event_name == 'pull_request' && needs.build-docs.result == 'success'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: doc-build-failure
          delete: true

      # PR Comments: Post sticky comments for link and build failures
      - name: Comment on PR - Link Check Failure
        if: github.event_name == 'pull_request' && needs.check-links.result == 'failure'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: doc-link-check
          message: |
            ## ðŸ”— Link Check Failed

            The link checker has found broken links in the changed documentation files.

            ### Action Required
            Please review the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) and fix the broken links.

            ### Common Causes
            - External links may have broken or moved
            - Internal links may reference renamed or deleted files
            - URLs may contain typos

            ---
            *Last checked: ${{ github.event.pull_request.head.sha }}*
            *This comment will update automatically when you push new commits*

      - name: Comment on PR - Lint Failure
        if: github.event_name == 'pull_request' && needs.lint-markdown.result == 'failure'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: doc-lint-failure
          message: |
            ## ðŸ“ Markdown Linting Failed

            The markdown linter has found issues in the changed documentation files.

            ### Action Required
            Please review the inline annotations in the **Files changed** tab and the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) to fix the linting errors.

            ### Common Issues
            - Missing blank lines around headings, lists, or code blocks
            - Inconsistent list styles
            - Code blocks without language specifiers
            - Emphasis used instead of proper headings

            ### Auto-fix Available
            Many issues can be automatically fixed by running:
            ```bash
            npx markdownlint-cli2 --fix "**/*.md"
            ```

            ---
            *Last checked: ${{ github.event.pull_request.head.sha }}*
            *This comment will update automatically when you push new commits*

      - name: Comment on PR - Build Failure
        if: github.event_name == 'pull_request' && needs.build-docs.result == 'failure'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: doc-build-failure
          message: |
            ## ðŸ“š Documentation Build Failed

            The mkdocs build has failed with errors.

            ### Action Required
            Please review the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) and fix the build errors.

            ### Common Causes
            - Invalid mkdocs.yml configuration
            - Missing or incorrectly formatted documentation files
            - Broken navigation structure
            - Plugin errors

            ---
            *Last checked: ${{ github.event.pull_request.head.sha }}*
            *This comment will update automatically when you push new commits*

      # Push to Main: Create/update GitHub issues for link and build failures
      - name: Create or update link check issue
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.check-links.result == 'failure'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const issueTitle = 'ðŸ”— Documentation Link Check Failed';
            const issueBody = `## Link Check Failures Detected

            The link checker has found broken links in the documentation.

            ### Action Required
            Please review the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) and fix the broken links.

            ### Common Causes
            - External links may have broken or moved
            - Internal links may reference renamed or deleted files
            - URLs may contain typos

            ---
            *Last checked: ${new Date().toISOString()}*
            *Run: ${context.runId}*
            *Commit: ${context.sha}*`;

            // Find existing link check issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'documentation,automated,link-check'
            });

            const existingIssue = issues.find(issue => issue.title === issueTitle);

            if (existingIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });
              console.log(`Updated issue #${existingIssue.number}`);
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['documentation', 'automated', 'link-check', 'bug']
              });
              console.log('Created new link check issue');
            }

      - name: Create or update lint failure issue
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.lint-markdown.result == 'failure'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const issueTitle = 'ðŸ“ Markdown Linting Failed';
            const issueBody = `## Markdown Linting Failures Detected

            The markdown linter has found issues in the documentation.

            ### Action Required
            Please review the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) and fix the linting errors.

            ### Common Issues
            - Missing blank lines around headings, lists, or code blocks
            - Inconsistent list styles
            - Code blocks without language specifiers
            - Emphasis used instead of proper headings

            ### Auto-fix Available
            Many issues can be automatically fixed by running:
            \`\`\`bash
            npx markdownlint-cli2 --fix "**/*.md"
            \`\`\`

            ---
            *Last checked: ${new Date().toISOString()}*
            *Run: ${context.runId}*
            *Commit: ${context.sha}*`;

            // Find existing lint issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'documentation,automated,lint'
            });

            const existingIssue = issues.find(issue => issue.title === issueTitle);

            if (existingIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });
              console.log(`Updated issue #${existingIssue.number}`);
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['documentation', 'automated', 'lint', 'bug']
              });
              console.log('Created new lint issue');
            }

      - name: Create or update build failure issue
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.build-docs.result == 'failure'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const issueTitle = 'ðŸ“š Documentation Build Failed';
            const issueBody = `## Documentation Build Failures Detected

            The mkdocs build has failed with errors.

            ### Action Required
            Please review the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) and fix the build errors.

            ### Common Causes
            - Invalid mkdocs.yml configuration
            - Missing or incorrectly formatted documentation files
            - Broken navigation structure
            - Plugin errors

            ---
            *Last checked: ${new Date().toISOString()}*
            *Run: ${context.runId}*
            *Commit: ${context.sha}*`;

            // Find existing build issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'documentation,automated,build'
            });

            const existingIssue = issues.find(issue => issue.title === issueTitle);

            if (existingIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });
              console.log(`Updated issue #${existingIssue.number}`);
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['documentation', 'automated', 'build', 'bug']
              });
              console.log('Created new build issue');
            }

      # Push to Main: Close issues when checks pass
      - name: Close issues when passing
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'documentation,automated'
            });

            // Close link check issue if links are now passing
            if ('${{ needs.check-links.result }}' === 'success') {
              const linkIssue = issues.find(issue => issue.title === 'ðŸ”— Documentation Link Check Failed');
              if (linkIssue) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: linkIssue.number,
                  state: 'closed'
                });
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: linkIssue.number,
                  body: `âœ… Link check now passing. Closing issue.\n\nRun: ${context.runId}`
                });
                console.log(`Closed link check issue #${linkIssue.number}`);
              }
            }

            // Close lint issue if linting is now passing
            if ('${{ needs.lint-markdown.result }}' === 'success') {
              const lintIssue = issues.find(issue => issue.title === 'ðŸ“ Markdown Linting Failed');
              if (lintIssue) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: lintIssue.number,
                  state: 'closed'
                });
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: lintIssue.number,
                  body: `âœ… Markdown linting now passing. Closing issue.\n\nRun: ${context.runId}`
                });
                console.log(`Closed lint issue #${lintIssue.number}`);
              }
            }

            // Close build issue if build is now passing
            if ('${{ needs.build-docs.result }}' === 'success') {
              const buildIssue = issues.find(issue => issue.title === 'ðŸ“š Documentation Build Failed');
              if (buildIssue) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: buildIssue.number,
                  state: 'closed'
                });
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: buildIssue.number,
                  body: `âœ… Documentation build now passing. Closing issue.\n\nRun: ${context.runId}`
                });
                console.log(`Closed build issue #${buildIssue.number}`);
              }
            }
