name: pre-commit
on:
  - push
permissions: read-all
jobs:
  pre-commit:
    runs-on: ubuntu-latest
    env:
      # Share Terraform providers across all terraform init calls to reduce disk usage
      TF_PLUGIN_CACHE_DIR: ${{ github.workspace }}/.terraform-plugin-cache
    steps:
      - name: Free up disk space
        # Remove pre-installed tools not needed for pre-commit hooks
        # This prevents "no space left on device" errors during terraform init
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          echo "Disk space after cleanup:"
          df -h

      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version: 3.12
      - uses: hashicorp/setup-terraform@v3
      - uses: terraform-linters/setup-tflint@v6

      - name: Create Terraform plugin cache directory
        run: mkdir -p $TF_PLUGIN_CACHE_DIR

      - name: Generate hash of all versions.tf files
        id: versions-hash
        run: |
          # Create a hash of all versions.tf files to use as cache key
          HASH=$(find . -name "versions.tf" -not -path "*/.terraform/*" -not -path "*/.external_modules/*" -type f -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "Versions hash: $HASH"

      - name: Cache Terraform lock files
        uses: actions/cache@v4
        id: lock-files-cache
        with:
          path: "**/.terraform.lock.hcl"
          key: terraform-lock-files-${{ steps.versions-hash.outputs.hash }}

      - name: Generate lock files for CI environment
        if: steps.lock-files-cache.outputs.cache-hit != 'true'
        # Generate .terraform.lock.hcl files with linux_amd64 checksums for all modules
        # This allows the plugin cache to work while keeping lock files out of the repo
        run: |
          echo "Generating lock files for all Terraform modules..."
          find . -name "versions.tf" -not -path "*/.terraform/*" -not -path "*/.external_modules/*" | while read -r versions_file; do
            dir=$(dirname "$versions_file")
            echo "Processing: $dir"
            (cd "$dir" && terraform init -backend=false && terraform providers lock -platform=linux_amd64) || echo "Failed to generate lock file for $dir"
          done
          echo "Lock file generation complete"

      - name: terraform-docs alias
        # This is necessary because terraform docs doesn't install super duper easily
        run: |
          mkdir -p $RUNNER_TEMP/docker-aliases
          echo "$RUNNER_TEMP/docker-aliases" >> $GITHUB_PATH

          {
            echo "#!/usr/bin/bash"
            echo "docker run --rm quay.io/terraform-docs/terraform-docs:0.20.0 \"\$@\""
          } >> $RUNNER_TEMP/docker-aliases/terraform-docs
          chmod +x $RUNNER_TEMP/docker-aliases/terraform-docs

      - uses: pre-commit/action@v3.0.1
