name: Documentation Preview Status

on:
  workflow_run:
    workflows: ["pages-build-deployment"]
    types: [completed]

permissions:
  pull-requests: write

jobs:
  update-comment:
    name: Update Preview Status
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Find associated PR
        id: find-pr
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            // Get the commit SHA from the workflow run
            const commitSha = context.payload.workflow_run.head_sha;

            // Find PRs associated with this commit
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: commitSha
            });

            if (prs.length === 0) {
              console.log('No PR found for this commit');
              return;
            }

            const pr = prs[0];
            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_head_sha', pr.head.sha.substring(0, 7));

      - name: Update comment to ready
        if: steps.find-pr.outputs.pr_number
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          number: ${{ steps.find-pr.outputs.pr_number }}
          header: doc-preview
          message: |
            ## ðŸ“š Documentation Preview

            âœ… **Your documentation preview is ready!**

            ðŸ”— **Preview URL**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/preview/pr-${{ steps.find-pr.outputs.pr_number }}/

            ### Build Information
            - **Status**: âœ… Live
            - **Commit**: `${{ steps.find-pr.outputs.pr_head_sha }}`

            ---
            *This preview will be automatically deleted when the PR is merged or closed.*
