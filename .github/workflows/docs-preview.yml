#====================================================================================================
## Process
# 1. When a PR modifies documentation files, this workflow triggers automatically
# 2. Validates documentation using reusable workflow (link checking + markdown linting)
# 3. Builds and deploys preview to preview/pr-{number} (depends on validation passing)
# 4. Posts comment with preview URL to the PR
#
## Note: PR previews use static deployment (not mike versioning)
# - Keeps PR previews separate from versioned releases
# - Deploys to preview/pr-{number} subdirectory
# - Does not pollute mike's version selector
#====================================================================================================
name: Documentation Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "docs/**"
      - "mkdocs.yml"
      - "**/README.md"
      - "CHANGELOG.md"
      - "CONTRIBUTING.md"
      - ".github/workflows/docs-preview.yml"

permissions:
  contents: write
  pull-requests: write
  pages: write

jobs:
  check-changes:
    name: Check for Documentation Changes
    # Only run for PRs from the same repository (not forks)
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    timeout-minutes: 5
    concurrency:
      group: docs-preview-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    outputs:
      docs_changed: ${{ steps.docs-changed.outputs.any_changed }}
      has_content_changes: ${{ steps.check-changes.outputs.has_changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Check for documentation changes
        id: docs-changed
        uses: tj-actions/changed-files@7dee1b0c1557f278e5c7dc244927139d78c0e22a # v47.0.4
        with:
          files: |
            docs/**
            mkdocs.yml
            **/README.md
            CHANGELOG.md
            CONTRIBUTING.md
        # Note: This check is needed despite the paths filter because the workflow
        # can also trigger when only the workflow file itself changes, in which case
        # we should skip the build and post an up-to-date comment

      - name: Setup Python
        if: steps.docs-changed.outputs.any_changed == 'true'
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: "docs/requirements.txt"

      - name: Install dependencies
        if: steps.docs-changed.outputs.any_changed == 'true'
        run: pip install -r docs/requirements.txt

      - name: Build documentation
        if: steps.docs-changed.outputs.any_changed == 'true'
        run: mkdocs build --strict --site-dir site

      - name: Check for content changes
        if: steps.docs-changed.outputs.any_changed == 'true'
        id: check-changes
        run: |
          # Clone gh-pages to check if files differ
          git clone --depth=1 --single-branch --branch gh-pages https://github.com/${{ github.repository }}.git /tmp/gh-pages

          # Compare the built site with existing preview (mike-based location)
          if [ -d "/tmp/gh-pages/preview-pr-${{ github.event.pull_request.number }}" ]; then
            if diff -qr site /tmp/gh-pages/preview-pr-${{ github.event.pull_request.number }} > /dev/null 2>&1; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
            fi
          else
            # Preview doesn't exist yet, so there are "changes" (new preview)
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy Preview
    needs: check-changes
    if: needs.check-changes.outputs.docs_changed == 'true' && needs.check-changes.outputs.has_content_changes == 'true'
    concurrency:
      group: gh-pages-deploy
      cancel-in-progress: false
    uses: ./.github/workflows/docs-build-and-deploy.yml
    permissions:
      contents: write
      pages: write
    with:
      mode: "preview"
      destination_dir: "preview/pr-${{ github.event.pull_request.number }}"

  comment:
    name: Update PR Comment
    needs: [check-changes, deploy]
    if: always() && needs.check-changes.outputs.docs_changed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Post deployment comment
        if: needs.deploy.result == 'success'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          number: ${{ github.event.pull_request.number }}
          header: doc-preview
          message: |
            ## ðŸ“š Documentation Preview

            âœ… **Preview deployed successfully!**

            ðŸ”— **Preview URL**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/preview-pr-${{ github.event.pull_request.number }}/

            ### ðŸ”’ Maintainer Action Required
            **The preview requires approval before it's accessible.** A maintainer must approve the GitHub Pages deployment in the [Environments section](https://github.com/${{ github.repository }}/deployments).

            Once approved, the preview will be accessible within 1-2 minutes.

            ### Build Information
            - **Status**: âœ… Deployed (awaiting approval)
            - **Commit**: `${{ github.event.pull_request.head.sha }}`
            - **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---
            *This preview will be automatically deleted when the PR is merged or closed.*

      - name: Post no-changes comment
        if: needs.check-changes.outputs.docs_changed == 'false' || needs.check-changes.outputs.has_content_changes == 'false'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          number: ${{ github.event.pull_request.number }}
          header: doc-preview
          message: |
            ## ðŸ“š Documentation Preview

            âœ… **Preview is already up-to-date!**

            ðŸ”— **Preview URL**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/preview-pr-${{ github.event.pull_request.number }}/

            ### Build Information
            - **Status**: âœ… Up-to-date
            - **Commit**: `${{ github.event.pull_request.head.sha }}`
            - **Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---
            *Note: The preview content hasn't changed since the last deployment.*
            *This preview will be automatically deleted when the PR is merged or closed.*
