name: "Invoke Terraform test on Comment for Perforce module"

# https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows
on:
  issue_comment:
    types: [created]

env:
  TF_LOG: INFO
  AWS_REGION: ${{secrets.AWS_REGION}}

jobs:
  terraform-testing:
    # TODO: scope these permissions down
    permissions: write-all
    # permissions:
    #   id-token: write # This is required for AWS OIDC connection
    #   contents: read # This is required for actions/checkout
    #   pull-requests: write # This is required for GitHub bot to comment on PR
    name: Terraform Testing
    # Only run if it#s a PR and the comment contains '/run-p4-tf-tests'
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/run-p4-tf-tests')
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: /modules/perforce/

    steps:
      # Comment on PR that the workflow has been scheduled
      - name: Comment on PR that the workflow has been scheduled
        uses: actions/github-script@v6
        if: always()
        with:
          script: |
            const name = '${{ github.workflow	}}';
            const url = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';
            const body = `Terraform tests have been scheduled üß™ \n${url}`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

      # Get branch of PR
      - name: Get branch of PR
        uses: xt0rted/pull-request-comment-branch@v1
        id: comment-branch

      # Set latest commit status as pending
      - name: Set latest commit status as pending
        uses: myrotvorets/set-commit-status-action@master
        with:
          sha: ${{ steps.comment-branch.outputs.head_sha }}
          token: ${{ secrets.GITHUB_TOKEN }}
          status: pending

      # Comment on PR that the workflow is in progress
      - name: Comment on PR that the workflow is in progress
        uses: actions/github-script@v6
        if: always()
        with:
          script: |
            const name = '${{ github.workflow	}}';
            const url = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';
            const body = `Terraform tests are in progress ‚è≥ \n${url}`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

      # Checkout the PR branch
      - name: Checkout PR branch ${{ steps.comment-branch.outputs.head_ref }}
        uses: actions/checkout@v3
        with:
          ref: ${{ steps.comment-branch.outputs.head_ref }}

      # Use GitHub Action secret to assume existing AWS IAM Role using OIDC connection
      - name: Configure AWS credentials from AWS account
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{secrets.AWS_IAM_ROLE}}
          aws-region: ${{secrets.AWS_REGION}}
          role-session-name: GitHub-OIDC-Terraform

      # Install the preferred version of the Terraform CLI
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
            terraform_version: 1.11.0

      # Format the Terraform code, continue even if there is an error
      - name: Terraform fmt
        id: fmt
        run: terraform fmt -check
        continue-on-error: true

        # Initialize a new or existing Terraform working directory
      - name: Terraform Init
        id: init
        run: terraform init

      # Run the actual Terraform tests
      - name: Terraform Test
        id: test
        run: terraform test
        # run terraform test -filter="tests/<your-desired-test>"

      # 7. Comment on PR the result of the workflow
      - name: Add workflow result as comment on PR
        uses: actions/github-script@v6
        if: always()
        with:
          script: |
            const name = '${{ github.workflow	}}';
            const url = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';
            const success = '${{ job.status }}' === 'success';
            const body = `${name}: ${success ? '‚úÖ The Terraform tests have completed successfully. Time for some Choreography and Merriment! ü™©' : '‚ùå The Terraform tests have completed with errors. Please review the failed GitHub action to resolve. Lumon expects more from you. üôÅ'}\n${url}`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

      # 8. Set the latest commit status to be the job status
      - name: Set latest commit status as ${{ job.status }}
        uses: myrotvorets/set-commit-status-action@master
        if: always()
        with:
          sha: ${{ steps.comment-branch.outputs.head_sha }}
          token: ${{ secrets.GITHUB_TOKEN }}
          status: ${{ job.status }}
